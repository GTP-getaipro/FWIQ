# ğŸ”„ OAuth Token Lifecycle - Visual Diagrams

## Overview
Visual diagrams showing the complete OAuth token lifecycle across all system components.

---

## ğŸ“Š Diagram 1: Initial OAuth Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    INITIAL OAUTH AUTHORIZATION                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User                Frontend              Microsoft           Backend              N8N                Supabase
 â”‚                     â”‚                      â”‚                  â”‚                   â”‚                    â”‚
 â”‚  Click "Connect"    â”‚                      â”‚                  â”‚                   â”‚                    â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚                  â”‚                   â”‚                    â”‚
 â”‚                     â”‚  Build OAuth URL     â”‚                  â”‚                   â”‚                    â”‚
 â”‚                     â”‚  (with offline_access)                  â”‚                   â”‚                    â”‚
 â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚                   â”‚                    â”‚
 â”‚                     â”‚                      â”‚  Show Consent    â”‚                   â”‚                    â”‚
 â”‚  Grant Permission   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚                   â”‚                    â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚                  â”‚                   â”‚                    â”‚
 â”‚                     â”‚                      â”‚  Return code     â”‚                   â”‚                    â”‚
 â”‚                     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚                   â”‚                    â”‚
 â”‚                     â”‚                      â”‚                  â”‚                   â”‚                    â”‚
 â”‚                     â”‚  POST /api/oauth/exchange-token        â”‚                   â”‚                    â”‚
 â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚                    â”‚
 â”‚                     â”‚                      â”‚                  â”‚                   â”‚                    â”‚
 â”‚                     â”‚                      â”‚  POST token      â”‚                   â”‚                    â”‚
 â”‚                     â”‚                      â”‚  endpoint        â”‚                   â”‚                    â”‚
 â”‚                     â”‚                      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚                    â”‚
 â”‚                     â”‚                      â”‚                  â”‚                   â”‚                    â”‚
 â”‚                     â”‚                      â”‚  Return tokens   â”‚                   â”‚                    â”‚
 â”‚                     â”‚                      â”‚  {access_token,  â”‚                   â”‚                    â”‚
 â”‚                     â”‚                      â”‚   refresh_token} â”‚                   â”‚                    â”‚
 â”‚                     â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚                    â”‚
 â”‚                     â”‚                      â”‚                  â”‚                   â”‚                    â”‚
 â”‚                     â”‚                      â”‚                  â”‚  POST /credentials                     â”‚
 â”‚                     â”‚                      â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
 â”‚                     â”‚                      â”‚                  â”‚                   â”‚                    â”‚
 â”‚                     â”‚                      â”‚                  â”‚  Store tokens     â”‚                    â”‚
 â”‚                     â”‚                      â”‚                  â”‚  {accessToken,    â”‚                    â”‚
 â”‚                     â”‚                      â”‚                  â”‚   refreshToken}   â”‚                    â”‚
 â”‚                     â”‚                      â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
 â”‚                     â”‚                      â”‚                  â”‚                   â”‚                    â”‚
 â”‚                     â”‚                      â”‚                  â”‚  credential_id    â”‚                    â”‚
 â”‚                     â”‚                      â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
 â”‚                     â”‚                      â”‚                  â”‚                   â”‚                    â”‚
 â”‚                     â”‚                      â”‚                  â”‚  INSERT integration                    â”‚
 â”‚                     â”‚                      â”‚                  â”‚  {user_id,                             â”‚
 â”‚                     â”‚                      â”‚                  â”‚   provider,                            â”‚
 â”‚                     â”‚                      â”‚                  â”‚   n8n_credential_id,                   â”‚
 â”‚                     â”‚                      â”‚                  â”‚   status: 'active'}                    â”‚
 â”‚                     â”‚                      â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                     â”‚                      â”‚                  â”‚                   â”‚                    â”‚
 â”‚  Success Toast      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚                    â”‚
 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚                  â”‚                   â”‚                    â”‚
 â”‚                     â”‚                      â”‚                  â”‚                   â”‚                    â”‚

Result: 
  âœ… N8N has both access_token AND refresh_token
  âœ… Supabase has n8n_credential_id link
  âœ… User can re-login without OAuth prompt
```

---

## ğŸ“Š Diagram 2: User Re-Login (Silent Reauth)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              USER RE-LOGIN (SILENT REAUTHORIZATION)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User            Frontend          Supabase           N8N            Microsoft Graph
 â”‚                 â”‚                  â”‚                â”‚                   â”‚
 â”‚  Login          â”‚                  â”‚                â”‚                   â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚                â”‚                   â”‚
 â”‚                 â”‚  Check Session   â”‚                â”‚                   â”‚
 â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚                   â”‚
 â”‚                 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚                   â”‚
 â”‚                 â”‚  Session OK      â”‚                â”‚                   â”‚
 â”‚                 â”‚                  â”‚                â”‚                   â”‚
 â”‚  Load Dashboard â”‚                  â”‚                â”‚                   â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚                â”‚                   â”‚
 â”‚                 â”‚                  â”‚                â”‚                   â”‚
 â”‚                 â”‚  GET integrationsâ”‚                â”‚                   â”‚
 â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚                   â”‚
 â”‚                 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚                   â”‚
 â”‚                 â”‚  status='active' â”‚                â”‚                   â”‚
 â”‚                 â”‚  n8n_cred_id=XXX â”‚                â”‚                   â”‚
 â”‚                 â”‚                  â”‚                â”‚                   â”‚
 â”‚                 â”‚  Verify credential exists         â”‚                   â”‚
 â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚
 â”‚                 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
 â”‚                 â”‚  Credential valid                â”‚                   â”‚
 â”‚                 â”‚  (has refreshToken)              â”‚                   â”‚
 â”‚                 â”‚                  â”‚                â”‚                   â”‚
 â”‚  Show Dashboard â”‚                  â”‚                â”‚                   â”‚
 â”‚  (No OAuth!)    â”‚                  â”‚                â”‚                   â”‚
 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚                â”‚                   â”‚
 â”‚                 â”‚                  â”‚                â”‚                   â”‚
 â”‚  Trigger Email  â”‚                  â”‚                â”‚                   â”‚
 â”‚  Workflow       â”‚                  â”‚                â”‚                   â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚                â”‚                   â”‚
 â”‚                 â”‚                  â”‚                â”‚                   â”‚
 â”‚                 â”‚  Execute workflow with credential â”‚                   â”‚
 â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚
 â”‚                 â”‚                  â”‚                â”‚                   â”‚
 â”‚                 â”‚                  â”‚                â”‚  Check if expired â”‚
 â”‚                 â”‚                  â”‚                â”‚  If yes: refresh  â”‚
 â”‚                 â”‚                  â”‚                â”‚  using refreshTokenâ”‚
 â”‚                 â”‚                  â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
 â”‚                 â”‚                  â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                 â”‚                  â”‚                â”‚  New access_token â”‚
 â”‚                 â”‚                  â”‚                â”‚                   â”‚
 â”‚                 â”‚                  â”‚                â”‚  Use fresh token  â”‚
 â”‚                 â”‚                  â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
 â”‚                 â”‚                  â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                 â”‚                  â”‚                â”‚  API Response     â”‚
 â”‚                 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
 â”‚                 â”‚  Workflow Success                â”‚                   â”‚
 â”‚                 â”‚                  â”‚                â”‚                   â”‚
 â”‚  Email Result   â”‚                  â”‚                â”‚                   â”‚
 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚                â”‚                   â”‚
 â”‚                 â”‚                  â”‚                â”‚                   â”‚

Result:
  âœ… No OAuth prompt shown
  âœ… Token auto-refreshed if needed
  âœ… Seamless user experience
```

---

## ğŸ“Š Diagram 3: Token Refresh (Automatic)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AUTOMATIC TOKEN REFRESH                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Workflow Execution      N8N Credential Store      Microsoft Token Endpoint
       â”‚                         â”‚                           â”‚
       â”‚  1. Check if token      â”‚                           â”‚
       â”‚     is expired          â”‚                           â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                           â”‚
       â”‚                         â”‚                           â”‚
       â”‚  2. Token expired       â”‚                           â”‚
       â”‚     (expiresIn < now)   â”‚                           â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
       â”‚                         â”‚                           â”‚
       â”‚  3. Need refresh        â”‚                           â”‚
       â”‚                         â”‚  4. POST refresh_token    â”‚
       â”‚                         â”‚     grant_type=refresh... â”‚
       â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚                         â”‚                           â”‚
       â”‚                         â”‚  5. Validate refresh      â”‚
       â”‚                         â”‚     token                 â”‚
       â”‚                         â”‚                           â”‚
       â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                         â”‚  6. Return new tokens     â”‚
       â”‚                         â”‚     {access_token,        â”‚
       â”‚                         â”‚      refresh_token (new), â”‚
       â”‚                         â”‚      expires_in}          â”‚
       â”‚                         â”‚                           â”‚
       â”‚  7. Update credential   â”‚                           â”‚
       â”‚     data with new tokensâ”‚                           â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
       â”‚                         â”‚                           â”‚
       â”‚  8. Continue workflow   â”‚                           â”‚
       â”‚     with fresh token    â”‚                           â”‚
       â–¼                         â”‚                           â”‚
  Graph API Call                 â”‚                           â”‚
  (Success)                      â”‚                           â”‚

Timeline: ~500ms total
User Experience: No interruption, seamless
```

---

## ğŸ“Š Diagram 4: Failure Scenario (Missing Refresh Token)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FAILURE: MISSING REFRESH TOKEN                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Workflow Execution      N8N Credential           Result
       â”‚                      â”‚                      â”‚
       â”‚  Check token         â”‚                      â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚
       â”‚                      â”‚                      â”‚
       â”‚  Token expired       â”‚                      â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚
       â”‚                      â”‚                      â”‚
       â”‚  Attempt refresh     â”‚                      â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚
       â”‚                      â”‚                      â”‚
       â”‚  âŒ refreshToken     â”‚                      â”‚
       â”‚     is NULL          â”‚                      â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚
       â”‚                      â”‚                      â”‚
       â”‚  Cannot refresh      â”‚                      â”‚
       â”‚                      â”‚                      â”‚
       â–¼                      â”‚                      â–¼
  Workflow FAILS              â”‚              "Unable to sign
  Error logged                â”‚               without access token"
       â”‚                      â”‚                      â”‚
       â”‚                      â”‚                      â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
                    User sees error OR
                    Integration marked inactive

FIX: Reauthorize credential with offline_access scope
```

---

## ğŸ“Š Diagram 5: Token Desynchronization

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TOKEN DESYNCHRONIZATION                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Scenario: Tokens stored in BOTH Supabase and N8N

Supabase                    N8N                   Microsoft
   â”‚                         â”‚                        â”‚
   â”‚  access_token_v1        â”‚  accessToken_v1        â”‚
   â”‚  refresh_token_v1       â”‚  refreshToken_v1       â”‚
   â”‚                         â”‚                        â”‚
   â”‚                         â”‚  Token expires         â”‚
   â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                         â”‚                        â”‚
   â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                         â”‚  New tokens            â”‚
   â”‚  STILL HAS v1! âŒ       â”‚  accessToken_v2 âœ…     â”‚
   â”‚  (Not updated)          â”‚  refreshToken_v2 âœ…    â”‚
   â”‚                         â”‚                        â”‚
   â”‚  Next workflow uses     â”‚                        â”‚
   â”‚  OLD token from         â”‚                        â”‚
   â”‚  Supabase âŒ            â”‚                        â”‚
   â”‚                         â”‚                        â”‚
   â–¼                         â”‚                        â–¼
  FAILS                      â”‚                   401 Unauthorized

SOLUTION: Store tokens ONLY in N8N, reference by ID in Supabase
```

---

## ğŸ“Š Diagram 6: Recommended Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              RECOMMENDED: N8N AS SINGLE SOURCE OF TRUTH             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—         â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—         â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   Supabase    â•‘         â•‘     N8N       â•‘         â•‘  Microsoft    â•‘
â•‘ (Metadata DB) â•‘         â•‘(Token Store)  â•‘         â•‘    Graph      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•         â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•         â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       â”‚                          â”‚                          â”‚
       â”‚  Stores:                 â”‚  Stores:                 â”‚
       â”‚  â€¢ user_id               â”‚  â€¢ access_token          â”‚
       â”‚  â€¢ provider              â”‚  â€¢ refresh_token         â”‚
       â”‚  â€¢ n8n_credential_id     â”‚  â€¢ expires_in            â”‚
       â”‚  â€¢ status                â”‚  â€¢ client_id             â”‚
       â”‚                          â”‚  â€¢ client_secret         â”‚
       â”‚  NO TOKENS! âœ…           â”‚                          â”‚
       â”‚                          â”‚  AUTHORITATIVE âœ…        â”‚
       â”‚                          â”‚                          â”‚
       â”‚                          â”‚  Auto-refreshes âœ…       â”‚
       â”‚                          â”‚                          â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                        Single Source of Truth
                        for OAuth Tokens

BENEFITS:
  âœ… No token desynchronization
  âœ… Automatic refresh handling
  âœ… Clear separation of concerns
  âœ… Easier to debug
  âœ… Production-proven pattern
```

---

## ğŸ“Š Diagram 7: Decision Tree - Show OAuth?

```
                    User Logs In
                         â”‚
                         â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Check Supabase       â”‚
              â”‚ integrations table   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Integration exists?  â”‚
              â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
                 â”‚ NO             â”‚ YES
                 â–¼                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Show OAuth  â”‚   â”‚ status='active'?â”‚
         â”‚ Prompt      â”‚   â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ NO       â”‚ YES
                              â–¼          â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ Show OAuth â”‚  â”‚ n8n_credential_id  â”‚
                      â”‚ Prompt     â”‚  â”‚ exists?            â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                                         â”‚ NO          â”‚ YES
                                         â–¼             â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚ Show OAuth â”‚  â”‚ Verify N8N   â”‚
                                  â”‚ Prompt     â”‚  â”‚ credential   â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                                                     â”‚ FAIL  â”‚ PASS
                                                     â–¼       â–¼
                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                              â”‚ Show OAuth â”‚  â”‚ Continue    â”‚
                                              â”‚ Prompt     â”‚  â”‚ to Dashboardâ”‚
                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ NO OAUTH! âœ…â”‚
                                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

KEY DECISION POINTS:
  1. Does integration exist?
  2. Is status 'active'?
  3. Is n8n_credential_id present?
  4. Does N8N credential exist?
  5. Does credential have refreshToken?

IF ALL YES â†’ No OAuth prompt needed âœ…
```

---

## ğŸ“Š Diagram 8: Token Expiry Timeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      TOKEN EXPIRY TIMELINE                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Time:    0min          30min          55min          60min         65min
         â”‚             â”‚              â”‚              â”‚             â”‚
         â”‚             â”‚              â”‚              â”‚             â”‚
OAuth    â”‚             â”‚              â”‚              â”‚             â”‚
Complete â–¼             â”‚              â”‚              â”‚             â”‚
      â”Œâ”€â”€â”€â”€â”€â”          â”‚              â”‚              â”‚             â”‚
      â”‚Tokenâ”‚          â”‚              â”‚              â”‚             â”‚
      â”‚Validâ”‚          â”‚              â”‚              â”‚             â”‚
      â””â”€â”€â”€â”€â”€â”˜          â”‚              â”‚              â”‚             â”‚
         â”‚             â–¼              â”‚              â”‚             â”‚
         â”‚        Still Valid         â”‚              â”‚             â”‚
         â”‚             â”‚              â–¼              â”‚             â”‚
         â”‚             â”‚        âš ï¸ Expiring Soon     â”‚             â”‚
         â”‚             â”‚        (< 5 min left)       â”‚             â”‚
         â”‚             â”‚              â”‚              â–¼             â”‚
         â”‚             â”‚              â”‚         âŒ EXPIRED         â”‚
         â”‚             â”‚              â”‚              â”‚             â–¼
         â”‚             â”‚              â”‚              â”‚        ğŸ”„ Auto
         â”‚             â”‚              â”‚              â”‚        Refresh
         â”‚             â”‚              â”‚              â”‚             â”‚
         â”‚             â”‚              â”‚              â”‚             â–¼
         â”‚             â”‚              â”‚              â”‚        âœ… New Token
         â”‚             â”‚              â”‚              â”‚        (Next 60min)
         â”‚             â”‚              â”‚              â”‚

Access Token:    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–“â–“â–“â–“â–“
                 â”‚â†â”€â”€â”€â”€â”€â”€ Valid â”€â”€â”€â”€â”€â”€â†’â”‚â†Expiringâ†’â”‚Xâ”‚â†Refreshâ†’â”‚

Refresh Token:   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ...
                 â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Valid (90 days) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚

KEY:
  â–ˆâ–ˆâ–ˆâ–ˆ Token valid and usable
  â–“â–“â–“â–“ Token expiring soon (< 5 min)
  XXXX Token expired
  .... Long-lived (90 days no activity)
```

---

## ğŸ“Š Diagram 9: Diagnostic & Fix Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   DIAGNOSTIC & AUTO-FIX FLOW                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                  npm run ops:diagnose
                          â”‚
                          â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Query Supabase integrations   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ For each integration:         â”‚
          â”‚ 1. Check Supabase tokens      â”‚
          â”‚ 2. Check N8N credential       â”‚
          â”‚ 3. Verify refresh token       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â–¼                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Healthy   â”‚      â”‚  Issues    â”‚
         â”‚  (report)  â”‚      â”‚  Found     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ Categorize by severity:       â”‚
                   â”‚ â€¢ CRITICAL (no refresh token) â”‚
                   â”‚ â€¢ WARNING (desync, inactive)  â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                      npm run ops:auto-fix
                                   â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â–¼                  â–¼                  â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ Deactivate   â”‚   â”‚ Clean        â”‚  â”‚ Mark for     â”‚
       â”‚ broken       â”‚   â”‚ orphaned     â”‚  â”‚ reauth       â”‚
       â”‚ integrations â”‚   â”‚ references   â”‚  â”‚              â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                  â”‚                  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ Generate report     â”‚
                        â”‚ Show actions needed â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                        Manual reauthorization
                        in N8N (if needed)
```

---

## ğŸ¯ Key Takeaways

### Token Storage Strategy
```
âœ… CORRECT:
  Supabase:  {user_id, provider, n8n_credential_id, status}
  N8N:       {accessToken, refreshToken, expiresIn}
  
âŒ WRONG:
  Supabase:  {user_id, provider, access_token, refresh_token}
  N8N:       {accessToken} â† Missing refreshToken!
```

### Critical Requirements
1. **offline_access** scope MUST be in OAuth URL
2. **refresh_token** MUST be stored in N8N credential
3. **n8n_credential_id** MUST be linked in Supabase
4. **N8N refresh** MUST be enabled in config

### Diagnostic Commands
```bash
npm run ops:diagnose        # Identify issues
npm run ops:auto-fix        # Attempt automated fix
npm run ops:full-diagnostic # Complete diagnosis + fix
```

---

## ğŸ“š Related Documentation

- [OAuth Token Flow Architecture](./OAUTH_TOKEN_FLOW_ARCHITECTURE.md)
- [OAuth Credential Management](../guides/OAUTH_CREDENTIAL_MANAGEMENT.md)
- [Outlook OAuth Fix](../fixes/OUTLOOK_OAUTH_REFRESH_TOKEN_FIX.md)
- [N8N Troubleshooting](../systems/N8N_CREDENTIAL_TROUBLESHOOTING.md)

---

**Visual diagrams make complex flows easier to understand!**

**Use these diagrams when:**
- Debugging OAuth issues
- Onboarding new developers
- Planning architecture changes
- Explaining system behavior

---

**Last Updated:** October 7, 2025  
**Maintained By:** FloworxV2 Architecture Team

